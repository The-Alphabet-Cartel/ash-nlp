# Ash-NLP Testing Suite Container
# FILE VERSION: v5.0
# LAST MODIFIED: 2025-12-30
# CLEAN ARCHITECTURE: v5.0 Compliant
# Repository: https://github.com/the-alphabet-cartel/ash-nlp

# Base image with CUDA support for GPU acceleration
FROM nvidia/cuda:12.1.0-runtime-ubuntu22.04

# Metadata
LABEL maintainer="The Alphabet Cartel <https://alphabetcartel.org>"
LABEL description="Ash-NLP v5.0 Testing Suite - Crisis Detection Model Evaluation"
LABEL version="5.0"

# Environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt update && apt install -y \
    python3.11 \
    python3-pip \
    python3.11-dev \
    git \
    curl \
    wget \
    ca-certificates \
    build-essential \
    dos2unix \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create symbolic link for python
RUN ln -s /usr/bin/python3.11 /usr/bin/python

# Upgrade pip
RUN pip install --upgrade pip setuptools wheel

# Copy requirements first (for better Docker layer caching)
COPY requirements-testing.txt /app/

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements-testing.txt

# Copy testing framework code
COPY testing/ /app/testing/
COPY managers/ /app/managers/
COPY config/ /app/config/

# Create necessary directories
RUN mkdir -p /app/testing/reports/output \
    /app/testing/cache/models \
    /app/logs

# Set permissions
RUN chmod -R 755 /app/testing \
    && chmod -R 777 /app/testing/reports/output \
    && chmod -R 777 /app/testing/cache \
    && chmod -R 777 /app/logs

# Copy entrypoint script
COPY docker/testing-entrypoint.sh /usr/local/bin/testing-entrypoint.sh
RUN chmod +x /usr/local/bin/testing-entrypoint.sh

# Expose port for potential web interface (future)
EXPOSE 30880

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import torch; print('CUDA:', torch.cuda.is_available())" || exit 1

# Default entrypoint
ENTRYPOINT ["/usr/local/bin/testing-entrypoint.sh"]

# Default command: run help
CMD ["--help"]
