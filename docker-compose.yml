services:
  ash-nlp:
    image: ghcr.io/the-alphabet-cartel/ash-nlp:latest
    # Uncomment for local development:
#    build:
#      context: .
#      dockerfile: Dockerfile

    container_name: ash-nlp
    restart: unless-stopped
    networks:
      - ash-network
    ports:
      - "${NLP_SERVICE_PORT:-8881}:${NLP_SERVICE_PORT:-8881}"
    environment:
      # Point to secret files
      - HUGGINGFACE_TOKEN=/run/secrets/huggingface_token

      # Core Python settings
      - GLOBAL_PYTHONUNBUFFERED=${GLOBAL_PYTHONUNBUFFERED:-1}
      
      # Hugging Face Configuration
      - NLP_HUGGINGFACE_CACHE_DIR=${NLP_HUGGINGFACE_CACHE_DIR:-./models/cache}
      
      # Learning System Configuration
      - GLOBAL_ENABLE_LEARNING_SYSTEM=${GLOBAL_ENABLE_LEARNING_SYSTEM:-true}
      - NLP_LEARNING_RATE=${NLP_LEARNING_RATE:-0.1}
      - NLP_MAX_LEARNING_ADJUSTMENTS_PER_DAY=${NLP_MAX_LEARNING_ADJUSTMENTS_PER_DAY:-50}
      - NLP_LEARNING_PERSISTENCE_FILE=${NLP_LEARNING_PERSISTENCE_FILE:-./learning_data/adjustments.json}
      - NLP_MIN_CONFIDENCE_ADJUSTMENT=${NLP_MIN_CONFIDENCE_ADJUSTMENT:-0.05}
      - NLP_MAX_CONFIDENCE_ADJUSTMENT=${NLP_MAX_CONFIDENCE_ADJUSTMENT:-0.30}
      
      # Model Configuration
      - NLP_DEPRESSION_MODEL=${NLP_DEPRESSION_MODEL:-rafalposwiata/deproberta-large-depression}
      - NLP_SENTIMENT_MODEL=${NLP_SENTIMENT_MODEL:-cardiffnlp/twitter-roberta-base-sentiment-latest}
      - NLP_MODEL_CACHE_DIR=${NLP_MODEL_CACHE_DIR:-./models/cache}
      
      # Hardware Configuration - Optimized for your RTX 3050
      - NLP_DEVICE=${NLP_DEVICE:-auto}
      - NLP_MODEL_PRECISION=${NLP_MODEL_PRECISION:-float16}
      
      # Performance Tuning - Tuned for your Ryzen 7 7700x
      - NLP_MAX_BATCH_SIZE=${NLP_MAX_BATCH_SIZE:-32}
      - NLP_INFERENCE_THREADS=${NLP_INFERENCE_THREADS:-4}
      - NLP_MAX_CONCURRENT_REQUESTS=${NLP_MAX_CONCURRENT_REQUESTS:-10}
      - NLP_REQUEST_TIMEOUT=${NLP_REQUEST_TIMEOUT:-30}
      
      # Server Configuration
      - NLP_SERVICE_HOST=${NLP_SERVICE_HOST:-0.0.0.0}
      - NLP_SERVICE_PORT=${NLP_SERVICE_PORT:-8881}
      - NLP_UVICORN_WORKERS=${NLP_UVICORN_WORKERS:-1}
      - NLP_RELOAD_ON_CHANGES=${NLP_RELOAD_ON_CHANGES:-false}
      
      # Logging Configuration
      - GLOBAL_LOG_LEVEL=${GLOBAL_LOG_LEVEL:-INFO}
      - NLP_LOG_FILE=${NLP_LOG_FILE:-nlp_service.log}
      - GLOBAL_ENABLE_DEBUG_LOGGING=${GLOBAL_ENABLE_DEBUG_LOGGING:-false}
      
      # Storage Paths
      - NLP_DATA_DIR=${NLP_DATA_DIR:-./data}
      - NLP_MODELS_DIR=${NLP_MODELS_DIR:-./models/cache}
      - NLP_LOGS_DIR=${NLP_LOGS_DIR:-./logs}
      - NLP_LEARNING_DATA_DIR=${NLP_LEARNING_DATA_DIR:-./learning_data}
      
      # Crisis Detection Thresholds
      - NLP_HIGH_CRISIS_THRESHOLD=${NLP_HIGH_CRISIS_THRESHOLD:-0.7}
      - NLP_MEDIUM_CRISIS_THRESHOLD=${NLP_MEDIUM_CRISIS_THRESHOLD:-0.4}
      - NLP_LOW_CRISIS_THRESHOLD=${NLP_LOW_CRISIS_THRESHOLD:-0.2}
      
      # Rate Limiting
      - NLP_MAX_REQUESTS_PER_MINUTE=${NLP_MAX_REQUESTS_PER_MINUTE:-60}
      - NLP_MAX_REQUESTS_PER_HOUR=${NLP_MAX_REQUESTS_PER_HOUR:-1000}
      
      # Security
      - GLOBAL_ALLOWED_IPS=${GLOBAL_ALLOWED_IPS:-10.20.30.0/24,127.0.0.1,::1}
      - GLOBAL_ENABLE_CORS=${GLOBAL_ENABLE_CORS:-true}
    volumes:
      - ./data:/app/data
      - ./models/cache:/app/models/cache
      - ./logs:/app/logs
      - ./learning_data:/app/learning_data
      - ./secrets:/run/secrets:ro
    deploy:
      resources:
        limits:
          memory: 8G      # Sufficient for your RTX 3050 setup
          cpus: '4'       # Half your Ryzen 7 7700x cores
        reservations:
          memory: 2G
          cpus: '1'
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

networks:
  ash-network:
    driver: bridge