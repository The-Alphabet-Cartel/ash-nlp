# ============================================================================
# Ash-NLP v5.0 Docker Compose Configuration
# ============================================================================
# FILE VERSION: v5.0-4-1.0-1
# LAST MODIFIED: 2026-01-17
# Repository: https://github.com/the-alphabet-cartel/ash-nlp
# Community: The Alphabet Cartel - https://discord.gg/alphabetcartel
# ============================================================================
#
# USAGE:
#   # Start services
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f ash-nlp
#
#   # Stop services
#   docker-compose down
#
#   # Rebuild and start
#   docker-compose up -d --build
#
# PUID/PGID:
#   Set PUID and PGID in your .env file to match the owner of your
#   mounted volumes. This ensures the container can read/write files
#   with the correct permissions.
#
#   Example (find your UID/GID):
#     id $(whoami)
#     # uid=1000(username) gid=1000(username) ...
#
#   Then in .env:
#     PUID=1000
#     PGID=1000
#
# SECRETS:
#   Secrets are stored in ./secrets/ directory:
#   - ./secrets/ash_nlp_discord_alert_token - Discord webhook for Ash-NLP alerts
#   - ./secrets/huggingface_token - HuggingFace API token
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v2.20+
#   - NVIDIA Container Toolkit (for GPU support)
#
# MODEL CACHING:
#   Models download at first startup (~5-15 min) and cache to ./models-cache/
#   Subsequent startups verify cache and start quickly (~30 sec)
#
# ============================================================================
### Common Variables ###
x-common: &common
  networks:
    - ash-network
  restart: unless-stopped

### Common Environmental Variables ###
x-env: &env
  PGID: ${PGID:-1000}
  PUID: ${PUID:-1000}
  TZ: ${TZ:-America/Los_Angeles}
  FORCE_COLOR: ${FORCE_COLOR:-1}

### Healthchecks ###
x-health: &health
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 120s
  start_interval: 10s

services:
  # ===========================================================================
  # Ash-NLP Service (GPU)
  # ===========================================================================
  ash-nlp:
    image: ghcr.io/the-alphabet-cartel/ash-nlp:latest
    container_name: ash-nlp
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    <<: *common

    # GPU Support (requires NVIDIA Container Toolkit)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    # Environment variables
    environment:
      <<: *env
      # GPU
      NVIDIA_VISIBLE_DEVICES: all

    env_file:
      - .env

    # Volume mounts
    volumes:
      # Model cache (persistent) - models download at startup, not build time
      # First startup: 5-15 min (downloads ~3GB of models)
      # Subsequent: ~30 sec (uses cached models)
      - ./models-cache:/app/models-cache
      # Logs
      - ./logs:/app/logs

    # Port mapping
    ports:
      - "30880:30880"

    # Docker Secrets
    secrets:
      - ash_internal_bypass_key
      - ash_nlp_discord_alert_token
      - huggingface_token

    # Health check
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30880/health"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "com.alphabetcartel.service=ash-nlp"
      - "com.alphabetcartel.version=5.0.0"
      - "com.alphabetcartel.description=Crisis Detection Backend"

# =============================================================================
# Secrets
# =============================================================================
secrets:
  ash_internal_bypass_key:
    file: ./secrets/ash_internal_bypass_key
  ash_nlp_discord_alert_token:
    file: ./secrets/ash_nlp_discord_alert_token
  huggingface_token:
    file: ./secrets/huggingface_token
  webhook_token:
    file: ./secrets/webhook_token

# =============================================================================
# Networks
# =============================================================================
networks:
  ash-network:
    name: ash-network
    driver: bridge
    external: true
