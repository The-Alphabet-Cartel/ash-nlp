# =============================================================================
# ASH NLP SERVICE CONFIGURATION - CENTRALIZED THRESHOLD MANAGEMENT
# Environment variables for the Enhanced NLP Service v4.3
# Repository: https://github.com/the-alphabet-cartel/ash-nlp
# Part of: The Alphabet Cartel (https://discord.gg/alphabetcartel) Ash Ecosystem
# =============================================================================

# =============================================================================
# HUGGING FACE CONFIGURATION
# =============================================================================
GLOBAL_HUGGINGFACE_TOKEN=/run/secrets/huggingface
NLP_HUGGINGFACE_CACHE_DIR=./models/cache

# =============================================================================
# LEARNING SYSTEM CONFIGURATION
# =============================================================================
GLOBAL_ENABLE_LEARNING_SYSTEM=true
NLP_LEARNING_RATE=0.1
NLP_MAX_LEARNING_ADJUSTMENTS_PER_DAY=50
NLP_LEARNING_PERSISTENCE_FILE=./learning_data/adjustments.json
NLP_MIN_CONFIDENCE_ADJUSTMENT=0.05
NLP_MAX_CONFIDENCE_ADJUSTMENT=0.30

# =============================================================================
# THREE-MODEL CONFIGURATION
# =============================================================================
NLP_DEPRESSION_MODEL=MoritzLaurer/deberta-v3-base-zeroshot-v2.0
NLP_SENTIMENT_MODEL=Lowerated/lm6-deberta-v3-topic-sentiment
NLP_EMOTIONAL_DISTRESS_MODEL=facebook/bart-large-mnli
NLP_MODEL_CACHE_DIR=./models/cache

# =============================================================================
# ENSEMBLE CONFIGURATION
# =============================================================================
NLP_ENSEMBLE_MODE=weighted
NLP_GAP_DETECTION_THRESHOLD=0.25
NLP_DISAGREEMENT_THRESHOLD=0.35
NLP_AUTO_FLAG_DISAGREEMENTS=true

# Model weights (must sum to 1.0)
NLP_DEPRESSION_MODEL_WEIGHT=0.6
NLP_SENTIMENT_MODEL_WEIGHT=0.15
NLP_EMOTIONAL_DISTRESS_MODEL_WEIGHT=0.25

# =============================================================================
# HARDWARE CONFIGURATION
# =============================================================================
NLP_DEVICE=auto
NLP_MODEL_PRECISION=float16

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================
NLP_MAX_BATCH_SIZE=32
NLP_INFERENCE_THREADS=16
NLP_MAX_CONCURRENT_REQUESTS=20
NLP_REQUEST_TIMEOUT=40

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================
NLP_SERVICE_HOST=0.0.0.0
NLP_SERVICE_PORT=8881
NLP_UVICORN_WORKERS=1
NLP_RELOAD_ON_CHANGES=false

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
GLOBAL_LOG_LEVEL=INFO
NLP_LOG_FILE=nlp_service.log
GLOBAL_ENABLE_DEBUG_MODE=false
NLP_FLIP_SENTIMENT_LOGIC=false

# =============================================================================
# STORAGE PATHS
# =============================================================================
NLP_DATA_DIR=./data
NLP_MODELS_DIR=./models/cache
NLP_LOGS_DIR=./logs
NLP_LEARNING_DATA_DIR=./learning_data

# =============================================================================
# CENTRALIZED CRISIS THRESHOLD CONFIGURATION
# ALL thresholds in one place - NO hard-coded values in code
# =============================================================================

# ============== CONSENSUS PREDICTION MAPPING THRESHOLDS ====================
# These control how consensus predictions map to crisis levels
# Used in: ensemble_endpoints.py _map_to_crisis_level()

# CRISIS prediction thresholds
NLP_CONSENSUS_CRISIS_TO_HIGH_THRESHOLD=0.50     # crisis + confidence >= 0.50 → HIGH
NLP_CONSENSUS_CRISIS_TO_MEDIUM_THRESHOLD=0.30   # crisis + confidence >= 0.30 → MEDIUM
# crisis + confidence < 0.30 → LOW (any crisis prediction gets at least LOW)

# MILD_CRISIS prediction thresholds  
NLP_CONSENSUS_MILD_CRISIS_TO_LOW_THRESHOLD=0.40 # mild_crisis + confidence >= 0.40 → LOW
# mild_crisis + confidence < 0.40 → NONE

# NEGATIVE sentiment thresholds
NLP_CONSENSUS_NEGATIVE_TO_LOW_THRESHOLD=0.70    # negative + confidence >= 0.70 → LOW
# negative + confidence < 0.70 → NONE

# UNKNOWN prediction fallback
NLP_CONSENSUS_UNKNOWN_TO_LOW_THRESHOLD=0.50     # unknown + confidence > 0.50 → LOW (conservative)
# unknown + confidence <= 0.50 → NONE

# ============== ENSEMBLE FINAL SCORING THRESHOLDS ==========================
# These are applied after consensus mapping (if used elsewhere)
# Legacy support for any code still using these

NLP_ENSEMBLE_HIGH_CRISIS_THRESHOLD=0.45
NLP_ENSEMBLE_MEDIUM_CRISIS_THRESHOLD=0.25  
NLP_ENSEMBLE_LOW_CRISIS_THRESHOLD=0.12

# ============== INDIVIDUAL MODEL THRESHOLDS ===============================
# For backward compatibility with any legacy single-model code

NLP_HIGH_CRISIS_THRESHOLD=0.45
NLP_MEDIUM_CRISIS_THRESHOLD=0.25
NLP_LOW_CRISIS_THRESHOLD=0.15

# ============== STAFF REVIEW THRESHOLDS ====================================
# Controls when cases require staff review

NLP_STAFF_REVIEW_HIGH_ALWAYS=true                    # HIGH always needs review
NLP_STAFF_REVIEW_MEDIUM_CONFIDENCE_THRESHOLD=0.45    # MEDIUM + confidence >= 0.45 needs review
NLP_STAFF_REVIEW_LOW_CONFIDENCE_THRESHOLD=0.75       # LOW + confidence >= 0.75 needs review
NLP_STAFF_REVIEW_ON_MODEL_DISAGREEMENT=true          # Any gap detected needs review

# ============== SAFETY AND BIAS CONTROLS ===================================

NLP_CONSENSUS_SAFETY_BIAS=0.03                # Small boost toward higher crisis levels
NLP_ENABLE_SAFETY_OVERRIDE=true               # Allow severe individual results to override consensus

# ============== RATE LIMITING ==============================================

NLP_MAX_REQUESTS_PER_MINUTE=120
NLP_MAX_REQUESTS_PER_HOUR=2000

# ============== SECURITY ===================================================

GLOBAL_ALLOWED_IPS=10.20.30.0/24,127.0.0.1,::1
GLOBAL_ENABLE_CORS=true

# ============== EXPERIMENTAL FEATURES ======================================

NLP_ENABLE_ENSEMBLE_ANALYSIS=true
NLP_ENABLE_GAP_DETECTION=true
NLP_ENABLE_CONFIDENCE_SPREADING=true
NLP_LOG_MODEL_DISAGREEMENTS=true