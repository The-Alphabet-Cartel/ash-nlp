# Ash-NLP Testing Suite - Docker Compose
# FILE VERSION: v5.0
# LAST MODIFIED: 2025-12-30
# CLEAN ARCHITECTURE: v5.0 Compliant
# Repository: https://github.com/the-alphabet-cartel/ash-nlp
# Discord: https://discord.gg/alphabetcartel
# Website: http://alphabetcartel.org
services:
  ash-nlp-testing:
    container_name: ash-nlp-testing
    build:
      context: .
      dockerfile: Dockerfile
    image: ash-nlp-testing:v5.0

    # GPU support (requires nvidia-container-toolkit)
    runtime: nvidia

    # Environment variables from .env
    env_file:
      - .env

    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility

      # Testing Configuration
      TEST_DEVICE: ${TEST_DEVICE:-cuda}
      TEST_BATCH_SIZE: ${TEST_BATCH_SIZE:-8}
      TEST_TIMEOUT: ${TEST_TIMEOUT:-30}
      TEST_VERBOSE: ${TEST_VERBOSE:-true}

      # Thresholds
      TEST_ACCURACY_THRESHOLD: ${TEST_ACCURACY_THRESHOLD:-0.85}
      TEST_LATENCY_THRESHOLD: ${TEST_LATENCY_THRESHOLD:-5000}
      TEST_VRAM_THRESHOLD: ${TEST_VRAM_THRESHOLD:-2000}

      # Model cache location
      TRANSFORMERS_CACHE: /app/testing/cache/models
      HF_HOME: /app/testing/cache/huggingface

    # Volume mounts
    volumes:
      # Source code (for development)
      - ./:/app/testing:rw
      #- ./managers:/app/managers:ro
      #- ./config:/app/config:ro

      # Output directories
      - ./reports:/app/testing/reports:rw
      - ./logs:/app/logs:rw

      # Model cache (persist between runs)
      - ./cache:/app/testing/cache:rw

      # Shared memory for PyTorch (recommended for GPU)
      - /dev/shm:/dev/shm

    # Network mode
    network_mode: bridge

    # Keep container running for interactive use
    stdin_open: true
    tty: true

    # Resource limits (adjust based on your server)
    shm_size: "8gb"

    # Restart policy
    restart: unless-stopped

    # Command: Default to interactive shell
    # Override with: docker-compose run ash-nlp-testing <command>
    command: bash

#volumes:
#  ash-nlp-testing-cache:
#    driver: local
#    name: ash-nlp-testing-cache

# Network configuration (if needed for future services)
networks:
  default:
    name: ash-nlp-testing-network
